---
title: "Abundance Modeling"
author: "Andy"
date: "3/14/2022"
output: html_document
---

# Models of Mosquito Abundance

```{r, echo = FALSE, warnings = FALSE, message = FALSE, include = FALSE}
library(glmmTMB)
library(DHARMa)
library(dotwhisker)
library(broom)
library(broom.mixed)
library(jtools)
library(viridis)
library(AICcmodavg)
```

```{r, echo = FALSE, warnings = FALSE, message = FALSE}
abundance.df <- read.csv("abundance_data.csv")
abundance.df$Pool_ID <- as.factor(abundance.df$Pool_ID)
abundance.df$Date <- as.factor(abundance.df$Date)

abiotic.df <- read.csv( "../temperature/temp_predictions.csv" )
abiotic.df <- abiotic.df[-c(2:13,15,17:20)]
abiotic.df$Pool_ID <- as.factor(abiotic.df$Pool_ID)

abundance.df <- merge(abundance.df, abiotic.df)
abundance.df$Skimmer_Z <- ( abundance.df$Skimmer_Dragonfly - mean( abundance.df$Skimmer_Dragonfly ) )/sd( abundance.df$Skimmer_Dragonfly )
abundance.df$Days_Between_Z <- ( abundance.df$Days_Between_Flood_Sampling - mean( abundance.df$Days_Between_Flood_Sampling ) )/sd( abundance.df$Days_Between_Flood_Sampling )
```

## Model Family
### Standard Poisson GLMM

```{r, echo = FALSE}
mosq_poisson <- glmmTMB(Mosquito ~ Skimmer_Z * MaxTemp_Z + (1 | Pool_ID), family = poisson(), data = abundance.df )
summary(mosq_poisson)
testDispersion(mosq_poisson) # It's overdispersed
testZeroInflation(mosq_poisson) # And zero-inflated
```


### Negative Binomial GLMM

```{r, echo = FALSE}
mosq_nbinom2 <- glmmTMB(Mosquito ~ Skimmer_Z * MaxTemp_Z + (1 | Pool_ID), family = nbinom2(), data = abundance.df )
summary(mosq_nbinom2)
testDispersion(mosq_nbinom2)
testZeroInflation(mosq_nbinom2)

# nbinom1 had a similar AIC (slightly lower) but an insanely high dispersion parameter
```


### Zero-Inflated Poisson GLMM

```{r, echo = FALSE}
mosq_trunc_poisson <- glmmTMB(Mosquito ~ Skimmer_Z * MaxTemp_Z + (1 | Pool_ID), ziformula = ~., family = truncated_poisson, data = abundance.df )
summary(mosq_trunc_poisson)
testDispersion(mosq_trunc_poisson)
testZeroInflation(mosq_trunc_poisson)
```


### Zero-Inflated Negative Binomial GLMM

```{r, echo = FALSE}
mosq_trunc_nbinom2 <- glmmTMB(Mosquito ~ Skimmer_Z * MaxTemp_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2, data = abundance.df )
summary(mosq_trunc_nbinom2)
testDispersion(mosq_trunc_nbinom2)
testZeroInflation(mosq_trunc_nbinom2) 

# Ditto here
```

The truncated negative binomial model seems to work the best (lowest AIC), and indicates a positive effect of temperature on mosquito abundance, a negative effect of dragonflies, and a positive interaction term. This suggests that mosquitoes are more abundant in warmer pools, less abundant where dragonflies are present, but temperature may mitigate this effect somewhat.


```{r, echo = FALSE, warnings = FALSE}
plot.df <- broom::tidy(mosq_trunc_nbinom2)
plot.df$model <- c("nbinom", "nbinom", "nbinom", "nbinom", "zi", "zi", "zi", "zi", "zi", "zi")
plot.df <- plot.df[-c(9,10),]
dwplot(plot.df, 
       vline = geom_vline(xintercept = 0, colour = "red", linetype = 2), 
       dot_args = list(size = 4), 
       line_args = list(size = 6)) + 
  theme_classic(base_size = 16) 
effect_plot(mosq_trunc_nbinom2, pred = MaxTemp_Z, interval = TRUE, plot.points = TRUE) 
effect_plot(mosq_trunc_nbinom2, pred = Skimmer_Z, interval = TRUE, plot.points = TRUE)

abundance.df$drgn_presence <- ifelse(abundance.df$Skimmer_Dragonfly > 0, 'Present', 'Absent')
abundance.df$drgn_presence <- as.factor(abundance.df$drgn_presence)
abundance.df$rel_temp <- ifelse(abundance.df$MaxTemp_Z > 0, 'Above Mean', 'Below Mean')
abundance.df$rel_temp <- as.factor(abundance.df$rel_temp)
abundance2.df <- abundance.df[which(abundance.df$Mosquito > 0),]
abundance3.df <- aggregate(abundance2.df$Mosquito, by = list(abundance2.df$rel_temp, abundance2.df$drgn_presence), FUN = 'mean')
colnames(abundance3.df) <- c("rel_temp", "drgn_presence", "Mosquito")
samplesize <- aggregate(abundance2.df$Mosquito, by = list(abundance2.df$rel_temp, abundance2.df$drgn_presence), FUN = 'length')
stdev <- aggregate(abundance2.df$Mosquito, by = list(abundance2.df$rel_temp, abundance2.df$drgn_presence), FUN = 'sd')
abundance3.df$std.err <- stdev[,3]/sqrt(samplesize[,3])

interaction.plot <- ggplot(data = abundance3.df, aes(y = Mosquito, x = drgn_presence, colour = rel_temp)) +
  geom_point(size = 5) +
  geom_errorbar(aes(ymin = Mosquito - std.err, ymax = Mosquito + std.err), width = 0.25, size = 0.75) +
  theme_classic( base_size = 24, base_line_size = 1 ) +   
  scale_y_log10(expand = c(0,0)) +
  xlab("Dragonfly Nymphs") +
  ylab("Mosquito Abundance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        aspect.ratio = 1) +
  labs(colour = "Temperature")

# ggsave( "interaction.png",
#         plot = interaction.plot,
#         units = c("mm"),
#         dpi = 300)
```

Note: a temperature Z score of 1 means that the pool reaches a daily maximum temperature of around 34$^\circ$C, and the mean number of skimmers (i.e., Z = 0) was a little over 1.


## Models Including Flooding and Other Variables

```{r, echo = FALSE}

mosq_days <- glmmTMB(Mosquito ~ Skimmer_Z * MaxTemp_Z + Days_Between_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2, data = abundance.df )
summary(mosq_days)
```

Including days since last flood doesn't improve the overall AIC, and doesn't shake out as a significant term.

```{r, echo = FALSE}
abundance.df$FloodedAt_Z <- (abundance.df$FloodedAt - mean(abundance.df$FloodedAt))/sd(abundance.df$FloodedAt)

mosq_floodheight <- glmmTMB(Mosquito ~ Skimmer_Z * MaxTemp_Z + FloodedAt_Z + Days_Between_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2, data = abundance.df )
summary(mosq_floodheight)
```

Including flood height AND days since last flood improves AIC and both are significant terms in the zero inflation model. This suggests that lower flood height pools are more likely to have mosquitoes, and pools that have flooded more recently also have a higher likelihood.

This needs some playing with for model selection.

```{r, echo = FALSE}
# Full ZI Model
mosq.cand.models <- list()

# Temperature alone
mosq.cand.models[[1]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[2]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[3]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[4]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[5]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[6]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[7]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)



# Drop Temperature from ZI
# Temperature alone
mosq.cand.models[[8]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[9]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[10]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[11]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[12]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[13]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[14]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)



# Drop Skimmers from ZI
# Temperature alone
mosq.cand.models[[15]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[16]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[17]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[18]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[19]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[20]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[21]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)



# Drop Date from ZI
# Temperature alone
mosq.cand.models[[22]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[23]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[24]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[25]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[26]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[27]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[28]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)



# Drop Temperature and Skimmers from ZI
# Temperature alone
mosq.cand.models[[29]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[30]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[31]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[32]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[33]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[34]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[35]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)



# Drop Temperature and Date from ZI
# Temperature alone
mosq.cand.models[[36]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[37]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[38]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[39]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[40]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[41]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[42]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)



# Drop Skimmers and Date from ZI
# Temperature alone
mosq.cand.models[[43]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[44]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[45]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[46]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[47]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[48]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[49]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)
```

```{r}
aic_table <- aictab(cand.set = mosq.cand.models[8:14], sort = TRUE)
aic_table
# write.csv(aic_table, file = "../abundance/aic_table.csv")
library(performance)
r2(mosq.cand.models[[8]])
r2(mosq.cand.models[[9]])
r2(mosq.cand.models[[10]])
r2(mosq.cand.models[[11]])
r2(mosq.cand.models[[12]])
r2(mosq.cand.models[[13]])
r2(mosq.cand.models[[14]])

summary(mosq.cand.models[[11]])
confint(mosq.cand.models[[11]])
```



```{r, echo = FALSE, warnings = FALSE}
plot1.df <- broom::tidy(mosq.cand.models[[11]])

# Issue is with pool level random effect?
plot1.df$model <- c("nbinom", "nbinom", "nbinom", "nbinom", "zi", "zi", "zi", "zi", "cond", "zi")
plot1.df <- plot1.df[-c(1,5,9,10),]
plot1.df$term <- c("Max Temp. (째C)", "Dragonflies", "Temp:Dragonflies", "Max Temp. (째C)", "Dragonflies", "Temp:Dragonflies")
plot2.df <- plot1.df[1:3,]
plot3.df <- plot1.df[4:6,]


coeff1.df <- subset(plot1.df, model == "zi")
coeff.plot1 <- dwplot(coeff1.df, 
       vline = geom_vline(xintercept = 0, colour = "grey80", linetype = 2, size = 1), 
       dot_args = list(size = 4, colour = "#F8766D"), 
       whisker_args = list(size = 0.75, colour = "#F8766D")) + 
  theme_classic( base_size = 16, base_line_size = 1 ) + 
  xlab("Coefficient Estimate") +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "none",
         aspect.ratio = 1)

coeff2.df <- subset(plot1.df, model == "nbinom")
coeff.plot2 <- dwplot(coeff2.df, 
       vline = geom_vline(xintercept = 0, colour = "grey80", linetype = 2, size = 1), 
       dot_args = list(size = 4, colour = "#619CFF"), 
       whisker_args = list(size = 0.75, colour = "#619CFF")) + 
  theme_classic( base_size = 16, base_line_size = 1 ) + 
  xlab("Coefficient Estimate") +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "none",
         aspect.ratio = 1)

library(cowplot)
Fig4.plot <- plot_grid( coeff.plot1, coeff.plot2,
                        labels = c("a)", "b)"),
                        nrow = 2,
                        align = "hv" )


# ggsave( "Fig4.png",
#         plot = Fig4.plot,
#         units = c("mm"),
#         dpi = 300 )


mosq_effect.1 <- effect_plot(mosq.cand.models[[11]], pred = MaxTemp_Z, interval = TRUE, plot.points = TRUE, y.label = "Prey Abundance", x.label = "Max Temperature (째C)", point.size = 0.75, line.thickness = 0.35) +  
  theme_classic( base_size = 11, base_line_size = 0.1 ) + 
  scale_y_continuous( expand = c(0, 0) ) +
  scale_x_continuous( expand = c(0, 0), 
                      breaks = c((25 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (27.5 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (30 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (32.5 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (35 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C)),
                      labels = c(25, 27.5, 30, 32.5, 35), 
                      limits = c((25 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C), 
                                 (35 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C) ) ) +
  coord_cartesian(ylim = c(0, 500)) +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "none",
         aspect.ratio = 1)

  
mosq_effect.2 <- effect_plot(mosq.cand.models[[11]], pred = Skimmer_Z, interval = TRUE, plot.points = TRUE, y.label = "Prey Abundance", x.label = "Predator Abundance", point.size = 0.75, line.thickness = 0.35) +  
  theme_classic( base_size = 11, base_line_size = 0.1 ) +
  scale_x_continuous( expand = c(0, 0), 
                      breaks = c((0 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly),
                                                   (5 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly),
                                                   (10 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly),
                                                   (15 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly),
                                                   (20 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly),
                                                   (25 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly),
                                                   (30 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly)), 
                      labels = c(0, 5, 10, 15, 20, 25, 30),
                      limits = c((0 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly), 
                                 (10 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly)) ) +
  scale_y_continuous( expand = c(0, 0) ) +
  coord_cartesian(ylim = c(0, 500)) +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "none",
         aspect.ratio = 1)


# Maybe an axis transformation would help? log doesn't seem to do it though
library(MASS)
library(ggeffects)
abundance.df$predicted <- predict(mosq.cand.models[[11]], newdata = abundance.df, type = "response")


tempZ_vec <- seq(-3.2, 2.2, by = 0.01) # temp z scores range from ~-3.2 to 2.2
dflyZ_vec1 <- rep(-0.3621401, length(tempZ_vec)) # 0 dragonflies z score
dflyZ_vec2 <- rep(-0.05790784, length(tempZ_vec)) # 1 dragonflies z score
date_vec <- rep("6/1/2021", length(tempZ_vec)) # it needs a date, so let's give it one from the middle of the data set...

nopred.df <- cbind(tempZ_vec, dflyZ_vec1, date_vec)
nopred.df<- as.data.frame(nopred.df)
colnames(nopred.df) <- c("MaxTemp_Z", "Skimmer_Z", "Date")
nopred.df$Date <- as.factor(nopred.df$Date)
nopred.df$MaxTemp_Z <- as.numeric(nopred.df$MaxTemp_Z)
nopred.df$Skimmer_Z <- as.numeric(nopred.df$Skimmer_Z)
nopred.df$predicted <- predict(mosq.cand.models[[11]], allow.new.levels = TRUE, newdata = nopred.df, type = "response")

onepred.df <- cbind(tempZ_vec, dflyZ_vec2, date_vec)
onepred.df<- as.data.frame(onepred.df)
colnames(onepred.df) <- c("MaxTemp_Z", "Skimmer_Z", "Date")
onepred.df$Date <- as.factor(onepred.df$Date)
onepred.df$MaxTemp_Z <- as.numeric(onepred.df$MaxTemp_Z)
onepred.df$Skimmer_Z <- as.numeric(onepred.df$Skimmer_Z)
onepred.df$predicted <- predict(mosq.cand.models[[11]], allow.new.levels = TRUE, newdata = onepred.df, type = "response")

propdiff <- (onepred.df$predicted - nopred.df$predicted)/nopred.df$predicted
simplot <- cbind(tempZ_vec, propdiff)
simplot.df <- as.data.frame(simplot)
plot(x = simplot.df$tempZ_vec, y = simplot.df$propdiff)


mosq_effect.3 <- ggplot(data = abundance.df, aes(x = MaxTemp_Z, y = predicted, colour = drgn_presence) ) +
  geom_point( size = 0.75, aes(x = MaxTemp_Z, y = Mosquito, colour = drgn_presence ) ) +
#  geom_smooth(method = "glm.nb") + Doesn't work since the predicted vals aren't integers
  geom_smooth(size = 0.35, aes( x = MaxTemp_Z, y = predicted, colour = drgn_presence ), 
                                method = 'glm', formula = y~x, method.args = list(family = gaussian(link = 'log'))) +
  scale_x_continuous( expand = c(0, 0), 
                      breaks = c((25 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (27.5 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (30 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (32.5 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (35 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C)),
                      labels = c(25, 27.5, 30, 32.5, 35), 
                      limits = c((25 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C), 
                                 (35 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C) ) ) +
  scale_y_continuous( expand = c(0, 0) ) +
  coord_cartesian(ylim = c(0, 100) ) +
  ylab("Observed Abundance") +
  xlab("Max Temperature (째C)") +
  scale_colour_discrete(name = "Predators") + 
  theme_classic( base_size = 11, base_line_size = 0.1 ) +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "right",
         aspect.ratio = 1)


legend <- get_legend(mosq_effect.3)
mosq_effect.3 <- mosq_effect.3 + theme(legend.position = "none")
mosq_effect.plot <- plot_grid( mosq_effect.1, mosq_effect.2, mosq_effect.3, legend,
                        labels = c("a)", "b)", "c)", ""),
                        nrow = 4,
                        label_x = 0.3,
                        rel_heights = c(1, 1, 1, 0.2),
                        align = "hv" )

# mosq_effect.plot <- plot_grid( mosq_effect.3, modelfig, legend,
#                         labels = c("a)", "b)", ""),
#                         nrow = 1,
#                         rel_widths = c(1, 1, 0.3),
#                         label_y = 0.7 )
# 
# 
# ggsave( "effectplot2.png",
#         plot = mosq_effect.plot,
#         units = c("mm"),
#         dpi = 300)

```


# Models of Dragonfly Abundance

## Model Family
### Poisson GLMM

```{r, echo = FALSE}
# drgn_poisson <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + (1 | Pool_ID), family = poisson(), data = abundance.df)
# summary(drgn_poisson)
# testZeroInflation(drgn_poisson)
# testDispersion(drgn_poisson) # Poisson has some issues with overdispersion
```


### Negative Binomial GLMM

```{r, echo = FALSE}
# drgn_nbinom2 <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + (1 | Pool_ID), family = nbinom2(), data = abundance.df)
# summary(drgn_nbinom2)
# testZeroInflation(drgn_nbinom2)
# testDispersion(drgn_nbinom2)
# 
# # Ditto about nbinom1() vs nbinom2()
```


### Zero-Inflated Poisson Model

```{r, echo = FALSE}
# drgn_trunc_poisson <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + (1 | Pool_ID), ziformula = ~., family = truncated_poisson, data = abundance.df )
# summary(drgn_trunc_poisson)
# testDispersion(drgn_trunc_poisson)
# testZeroInflation(drgn_trunc_poisson)
```


### Zero-Inflated Negative Binomial Model

```{r, echo = FALSE}
# drgn_trunc_nbinom2 <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)
# summary(drgn_trunc_nbinom2)
# testZeroInflation(drgn_trunc_nbinom2)
# testDispersion(drgn_trunc_nbinom2)
# 
# # There's still a bit of overdispersion here, but it beats nbinom1()
```

## Playing with Additional Variables

```{r, echo = FALSE}
# drgn_trunc_nbinom2 <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + Pct_Shaded_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)
# summary(drgn_trunc_nbinom2)
```

The zero-inflated negative binomial model has the lowest AIC. Dragonfly abundance isn't correlated with temperature, but their presence (from the zero-inflation model) seems to be more common in unshaded (but not necessarily warmer!) pools.

Now to play with additional variables of importance (e.g., days since last flood from Stunkle et al. 2021). It might also help to exclude temperature from the above model.

```{r, echo = FALSE}
shade.dat <- read.csv("../temperature/abiotic_data.csv")
shade.dat$Pool_ID <- as.factor(shade.dat$Pool_ID)
shade.dat$Pct_Shaded <- as.numeric(shade.dat$Pct_Shaded)
shade.dat <- shade.dat[-c(2:7,9)]
abundance.df <- merge(abundance.df, shade.dat)
abundance.df$Pct_Shaded <- abundance.df$Pct_Shaded/100
abundance.df$Pct_Shaded_Z <- (abundance.df$Pct_Shaded - mean(abundance.df$Pct_Shaded))/sd(abundance.df$Pct_Shaded)
dfly.cand.models <- list()

# Temperature alone
dfly.cand.models[[1]] <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Shading alone
dfly.cand.models[[2]] <- glmmTMB(Skimmer_Dragonfly ~ Pct_Shaded_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
dfly.cand.models[[3]] <- glmmTMB(Skimmer_Dragonfly ~ Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Temperature and shading
dfly.cand.models[[4]] <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + Pct_Shaded_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
dfly.cand.models[[5]] <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Shading and days since
dfly.cand.models[[6]] <- glmmTMB(Skimmer_Dragonfly ~ Pct_Shaded_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# All three
dfly.cand.models[[7]] <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + Pct_Shaded_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)


r2(dfly.cand.models[[1]])
r2(dfly.cand.models[[2]])
r2(dfly.cand.models[[3]])
r2(dfly.cand.models[[4]])
r2(dfly.cand.models[[5]])
r2(dfly.cand.models[[6]])
r2(dfly.cand.models[[7]])


summary(dfly.cand.models[[2]])
confint(dfly.cand.models[[6]])
summary(dfly.cand.models[[6]])
```

Models 2 and 6 do best (and are roughly equivalent), which include just shading (mod2) or shading and days since last flood (mod6). Both suggest that less shady pools  should have dragonflies (i.e., the zero-inflated component) but aren't predictors of abundance.

Similarly here, using flood height vs. time since last flood is roughly equivalent.

```{r}
# plot3.df <- broom::tidy(dfly.cand.models[[6]])
# plot3.df$model <- c("nbinom", "nbinom", "nbinom", "zi", "zi", "zi", "cond", "zi")
# plot3.df <- plot3.df[-c(1,4,7,8),]
# plot3.df$term <- c("Shading", "Days Since Flood", "Shading", "Days Since Flood")
# plot3.df$model <- as.factor(plot3.df$model)
# 
# plot4.df <- subset(plot3.df, model == "zi")
# coeff.plot4 <- dwplot(plot4.df, 
#        vline = geom_vline(xintercept = 0, colour = "grey80", linetype = 2, size = 1), 
#        dot_args = list(size = 4, colour = "#F8766D"), 
#        whisker_args = list(size = 0.75, colour = "#F8766D")) + 
#   theme_classic( base_size = 20, base_line_size = 1 ) + 
#   xlab("Coefficient Estimate") +
#   theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
#          legend.position = "none",
#          aspect.ratio = 1)
# 
# plot5.df <- subset(plot3.df, model == "nbinom")
# coeff.plot5 <- dwplot(plot5.df, 
#        vline = geom_vline(xintercept = 0, colour = "grey80", linetype = 2, size = 1), 
#        dot_args = list(size = 4, colour = "#619CFF"), 
#        whisker_args = list(size = 0.75, colour = "#619CFF")) + 
#   theme_classic( base_size = 20, base_line_size = 1 ) + 
#   xlab("Coefficient Estimate") +
#   theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
#          legend.position = "none",
#          aspect.ratio = 1)
# 
# # library(cowplot)
# # Fig3.plot <- plot_grid( coeff.plot1, coeff.plot2,
# #                         labels = c( "(a)", "(b)" ),
# #                         label_size = 16,
# #                         label_x = 0.2,
# #                         label_y = 0.99,
# #                         nrow = 2,
# #                         align = "hv" )
# 
# ggsave( "Fig4.png",
#         plot = coeff.plot4,
#         units = c("mm"),
#         dpi = 300 )
# 
# ggsave( "Fig5.png",
#         plot = coeff.plot5,
#         units = c("mm"),
#         dpi = 300 )
# 
# # dfly_effect.1 <- effect_plot(dfly.cand.models[[6]], pred = Pct_Shaded_Z, interval = TRUE, plot.points = TRUE, y.label = "Dragonfly Abundance", x.label = "Shading") 
# # dfly_effect.2 <- effect_plot(dfly.cand.models[[6]], pred = Days_Between_Z, interval = TRUE, plot.points = TRUE, y.label = "", x.label = "Days Since Last Flooded")
# # 
# # Fig4.plot <-  plot_grid( mosq_effect.1, mosq_effect.2, dfly_effect.1, dfly_effect.2,
# #                         labels = c( "(a)", "(b)", "(c)", "(d)" ),
# #                         label_size = 16,
# #                         label_x = 0.2,
# #                         label_y = 0.99,
# #                         nrow = 2,
# #                         align = "hv" )
# # 
# # ggsave( "Fig4.png",
# #         plot = Fig4.plot,
# #         units = c("mm"),
# #         dpi = 300 )
```