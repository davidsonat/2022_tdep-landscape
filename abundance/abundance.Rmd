---
title: "Abundance Modeling"
author: "Andy"
date: "3/14/2022"
output: html_document
---

# Models of Mosquito Abundance

```{r, echo = FALSE, warnings = FALSE, message = FALSE, include = FALSE}
library(glmmTMB)
library(DHARMa)
library(dotwhisker)
library(broom)
library(broom.mixed)
library(ggeffects)
library(AICcmodavg)
library(performance)
library(cowplot)
```

```{r, echo = FALSE, warnings = FALSE, message = FALSE}
abundance.df <- read.csv("abundance_data.csv")
abundance.df$Pool_ID <- as.factor(abundance.df$Pool_ID)
abundance.df$Date <- as.factor(abundance.df$Date)

abiotic.df <- read.csv( "../temperature/temp_predictions.csv" )
abiotic.df <- abiotic.df[-c(2:13,15,17:20)]
abiotic.df$Pool_ID <- as.factor(abiotic.df$Pool_ID)

abundance.df <- merge(abundance.df, abiotic.df)
abundance.df$Skimmer_Z <- ( abundance.df$Skimmer_Dragonfly - mean( abundance.df$Skimmer_Dragonfly ) )/sd( abundance.df$Skimmer_Dragonfly )
abundance.df$Days_Between_Z <- ( abundance.df$Days_Between_Flood_Sampling - mean( abundance.df$Days_Between_Flood_Sampling ) )/sd( abundance.df$Days_Between_Flood_Sampling )
abundance.df$drgn_presence <- ifelse(abundance.df$Skimmer_Dragonfly > 0, 'Present', 'Absent')
abundance.df$drgn_presence <- as.factor(abundance.df$drgn_presence)
```

## Model Family
### Standard Poisson GLMM

```{r, echo = FALSE}
mosq_poisson <- glmmTMB(Mosquito ~ Skimmer_Z * MaxTemp_Z + (1 | Pool_ID), family = poisson(), data = abundance.df )
summary(mosq_poisson)
testDispersion(mosq_poisson) # It's overdispersed
testZeroInflation(mosq_poisson) # And zero-inflated
```


### Negative Binomial GLMM

```{r, echo = FALSE}
mosq_nbinom2 <- glmmTMB(Mosquito ~ Skimmer_Z * MaxTemp_Z + (1 | Pool_ID), family = nbinom2(), data = abundance.df )
summary(mosq_nbinom2)
testDispersion(mosq_nbinom2)
testZeroInflation(mosq_nbinom2)

# nbinom1 had a similar AIC (slightly lower) but an insanely high dispersion parameter
```


### Zero-Inflated Poisson GLMM

```{r, echo = FALSE}
mosq_trunc_poisson <- glmmTMB(Mosquito ~ Skimmer_Z * MaxTemp_Z + (1 | Pool_ID), ziformula = ~., family = truncated_poisson, data = abundance.df )
summary(mosq_trunc_poisson)
testDispersion(mosq_trunc_poisson)
testZeroInflation(mosq_trunc_poisson)
```


### Zero-Inflated Negative Binomial GLMM

```{r, echo = FALSE}
mosq_trunc_nbinom2 <- glmmTMB(Mosquito ~ Skimmer_Z * MaxTemp_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2, data = abundance.df )
summary(mosq_trunc_nbinom2)
testDispersion(mosq_trunc_nbinom2)
testZeroInflation(mosq_trunc_nbinom2) 

# Ditto here
```

The truncated negative binomial model seems to work the best (lowest AIC), and indicates a positive effect of temperature on mosquito abundance, a negative effect of dragonflies, and a positive interaction term. This suggests that mosquitoes are more abundant in warmer pools, less abundant where dragonflies are present, but temperature may mitigate this effect somewhat.


## Models Including Flooding and Other Variables

```{r, echo = FALSE}
# Full ZI Model
mosq.cand.models <- list()

# Temperature alone
mosq.cand.models[[1]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[2]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[3]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[4]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[5]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[6]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[7]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)



# Drop Temperature from ZI
# Temperature alone
mosq.cand.models[[8]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[9]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[10]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[11]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[12]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[13]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[14]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)



# Drop Skimmers from ZI
# Temperature alone
mosq.cand.models[[15]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[16]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[17]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[18]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[19]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[20]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[21]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z + (1 | Date), family = truncated_nbinom2(), data = abundance.df)



# Drop Date from ZI
# Temperature alone
mosq.cand.models[[22]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[23]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[24]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[25]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[26]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[27]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[28]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z * MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)



# Drop Temperature and Skimmers from ZI
# Temperature alone
mosq.cand.models[[29]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[30]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[31]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[32]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[33]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[34]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[35]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ (1 | Date), family = truncated_nbinom2(), data = abundance.df)



# Drop Temperature and Date from ZI
# Temperature alone
mosq.cand.models[[36]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[37]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[38]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[39]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[40]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[41]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[42]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ Skimmer_Z, family = truncated_nbinom2(), data = abundance.df)



# Drop Skimmers and Date from ZI
# Temperature alone
mosq.cand.models[[43]] <- glmmTMB(Mosquito ~ MaxTemp_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[44]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[45]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[46]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[47]] <- glmmTMB(Mosquito ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[48]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[49]] <- glmmTMB(Mosquito ~ MaxTemp_Z * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~ MaxTemp_Z, family = truncated_nbinom2(), data = abundance.df)
```

```{r}
aic_table <- aictab(cand.set = mosq.cand.models[8:14], sort = TRUE)
aic_table

r2(mosq.cand.models[[8]])
r2(mosq.cand.models[[9]])
r2(mosq.cand.models[[10]])
r2(mosq.cand.models[[11]])
r2(mosq.cand.models[[12]])
r2(mosq.cand.models[[13]])
r2(mosq.cand.models[[14]])

summary(mosq.cand.models[[11]])
confint(mosq.cand.models[[11]])
```



```{r}
temp_effect <- ggpredict(mosq.cand.models[[11]], terms = c("MaxTemp_Z [all]"), ci.lvl = 0.95, type = "fe.zi")
temp_effect.plot <- ggplot(temp_effect, aes(x = x, y = predicted)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .1) +
  geom_point(abundance.df, mapping = aes(x = MaxTemp_Z, y = Mosquito), size = 0.75) +
  theme_classic( base_size = 11, base_line_size = 0.1 ) +
  scale_y_continuous( expand = c(0, 0) ) +
  scale_x_continuous( expand = c(0, 0),
                      breaks = c((25 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (27.5 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (30 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (32.5 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (35 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C)),
                      labels = c(27.5, 30, 32.5, 35),
                      limits = c((26.5 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (36.125 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C) ) ) +
  coord_cartesian(ylim = c(0, 500)) +
  xlab("Max Temperature (°C)") +
  ylab("Prey Abundance") +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "none",
         aspect.ratio = 1)



pred_effect <- ggpredict(mosq.cand.models[[11]], terms = c("Skimmer_Z [all]"), ci.lvl = 0.95, type = "fe.zi")
pred_effect.plot <- ggplot(pred_effect, aes(x, predicted)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .1) +
  geom_point(abundance.df, mapping = aes(x = Skimmer_Z, y = Mosquito), size = 0.75) + 
  theme_classic( base_size = 11, base_line_size = 0.1 ) +
  scale_x_continuous( expand = c(0, 0), 
                      breaks = c((0 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly),
                                                   (2 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly),
                                                   (4 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly),
                                                   (6 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly),
                                                   (8 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly),
                                                   (10 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly)),
                      labels = c(0, 2, 4, 6, 8, 10),
                      limits = c((0 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly), 
                                 (10 - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly)) ) +
  scale_y_continuous( expand = c(0, 0) ) +
  coord_cartesian(ylim = c(0, 50)) +
  xlab("Predator Abundance") +
  ylab("Prey Abundance") +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "none",
         aspect.ratio = 1)



int_effect <- ggpredict(mosq.cand.models[[11]], terms = c("MaxTemp_Z", "Skimmer_Z"), ci.lvl = 0.95, type = "fe.zi")
int_effect <- ggpredict(mosq.cand.models[[11]], terms = c("MaxTemp_Z [all]", "Skimmer_Z [all]"), ci.lvl = 0.95, type = "fe.zi")
int_effect <- int_effect[ which(int_effect$group == '-0.36' | int_effect$group == '-0.06' | int_effect$group == '0.25'), ] # This corresponds to 0, 1, or 2 skimmers
int_effect.obs <- abundance.df[ which(abundance.df$Skimmer_Dragonfly == '0' | abundance.df$Skimmer_Dragonfly == '1' | abundance.df$Skimmer_Dragonfly == '2'), ] # Grab the observed values
int_effect.obs$Skimmer_Z <- round(int_effect.obs$Skimmer_Z, digits = 2) # Round off
int_effect.obs$Skimmer_Z <- as.factor(int_effect.obs$Skimmer_Z) # Convert to factor
int_effect.plot <- ggplot(int_effect, aes(x, predicted, colour = group)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.25, show.legend = F, colour = NA) +
  geom_point(int_effect.obs, mapping = aes(x = MaxTemp_Z, y = Mosquito, colour = Skimmer_Z), size = 0.75) +
  theme_classic( base_size = 11, base_line_size = 0.1 ) +
  scale_y_continuous( expand = c(0, 0) ) +
  scale_x_continuous( expand = c(0, 0),
                      breaks = c((25 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (27.5 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (30 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (32.5 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (35 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C)),
                      labels = c(25, 27.5, 30, 32.5, 35),
                      limits = c((26.5 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C),
                                 (36.125 - mean(abundance.df$MaxTemp_Predicted_C))/sd(abundance.df$MaxTemp_Predicted_C) ) ) +
  coord_cartesian(ylim = c(0, 500)) +
  scale_colour_discrete(name = "Predators", labels = c('0', '1', '2')) +
  xlab("Max Temperature (°C)") +
  ylab("Prey Abundance") +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "bottom",
         aspect.ratio = 1)

legend <- get_legend(int_effect.plot)
int_effect.plot <- int_effect.plot + theme(legend.position = "none")

Fig5.plot <- plot_grid(temp_effect.plot, pred_effect.plot, int_effect.plot, legend,
                       ncol = 1, 
                       align = c("hv"), 
                       axis = c("l"),
                       labels = c("a)", "b)", "c)", ""),
                       label_x = 0.25,
                       rel_heights = c(1,1,1,0.2))

ggsave("../abundance/newplot.png", plot = Fig5.plot, units = c( "mm" ), dpi = 300, bg = "white" )
```


```{r}
# Humoring James
nopred <- int_effect[which(int_effect$group == '-0.36'),]
onepred <- int_effect[which(int_effect$group == '-0.06'),]
predeffect <- (onepred$predicted - nopred$predicted)/nopred$predicted
plot(x = onepred$x, y = predeffect, ylab = "Net Predator Effect", xlab = "Max Temperature (Z)")
```


# Models of Dragonfly Abundance

## Model Family
### Poisson GLMM

```{r, echo = FALSE}
# drgn_poisson <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + (1 | Pool_ID), family = poisson(), data = abundance.df)
# summary(drgn_poisson)
# testZeroInflation(drgn_poisson)
# testDispersion(drgn_poisson) # Poisson has some issues with overdispersion
```


### Negative Binomial GLMM

```{r, echo = FALSE}
# drgn_nbinom2 <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + (1 | Pool_ID), family = nbinom2(), data = abundance.df)
# summary(drgn_nbinom2)
# testZeroInflation(drgn_nbinom2)
# testDispersion(drgn_nbinom2)
# 
# # Ditto about nbinom1() vs nbinom2()
```


### Zero-Inflated Poisson Model

```{r, echo = FALSE}
# drgn_trunc_poisson <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + (1 | Pool_ID), ziformula = ~., family = truncated_poisson, data = abundance.df )
# summary(drgn_trunc_poisson)
# testDispersion(drgn_trunc_poisson)
# testZeroInflation(drgn_trunc_poisson)
```


### Zero-Inflated Negative Binomial Model

```{r, echo = FALSE}
# drgn_trunc_nbinom2 <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)
# summary(drgn_trunc_nbinom2)
# testZeroInflation(drgn_trunc_nbinom2)
# testDispersion(drgn_trunc_nbinom2)
# 
# # There's still a bit of overdispersion here, but it beats nbinom1()
```

## Playing with Additional Variables

```{r, echo = FALSE}
# drgn_trunc_nbinom2 <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + Pct_Shaded_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)
# summary(drgn_trunc_nbinom2)
```

The zero-inflated negative binomial model has the lowest AIC. Dragonfly abundance isn't correlated with temperature, but their presence (from the zero-inflation model) seems to be more common in unshaded (but not necessarily warmer!) pools.

Now to play with additional variables of importance (e.g., days since last flood from Stunkle et al. 2021). It might also help to exclude temperature from the above model.

```{r, echo = FALSE}
shade.dat <- read.csv("../temperature/abiotic_data.csv")
shade.dat$Pool_ID <- as.factor(shade.dat$Pool_ID)
shade.dat$Pct_Shaded <- as.numeric(shade.dat$Pct_Shaded)
shade.dat <- shade.dat[-c(2:7,9)]
abundance.df <- merge(abundance.df, shade.dat)
abundance.df$Pct_Shaded <- abundance.df$Pct_Shaded/100
abundance.df$Pct_Shaded_Z <- (abundance.df$Pct_Shaded - mean(abundance.df$Pct_Shaded))/sd(abundance.df$Pct_Shaded)
dfly.cand.models <- list()

# Temperature alone
dfly.cand.models[[1]] <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Shading alone
dfly.cand.models[[2]] <- glmmTMB(Skimmer_Dragonfly ~ Pct_Shaded_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
dfly.cand.models[[3]] <- glmmTMB(Skimmer_Dragonfly ~ Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Temperature and shading
dfly.cand.models[[4]] <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + Pct_Shaded_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
dfly.cand.models[[5]] <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Shading and days since
dfly.cand.models[[6]] <- glmmTMB(Skimmer_Dragonfly ~ Pct_Shaded_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# All three
dfly.cand.models[[7]] <- glmmTMB(Skimmer_Dragonfly ~ MaxTemp_Z + Pct_Shaded_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)


r2(dfly.cand.models[[1]])
r2(dfly.cand.models[[2]])
r2(dfly.cand.models[[3]])
r2(dfly.cand.models[[4]])
r2(dfly.cand.models[[5]])
r2(dfly.cand.models[[6]])
r2(dfly.cand.models[[7]])


summary(dfly.cand.models[[2]])
confint(dfly.cand.models[[6]])
summary(dfly.cand.models[[6]])
```

Models 2 and 6 do best (and are roughly equivalent), which include just shading (mod2) or shading and days since last flood (mod6). Both suggest that less shady pools  should have dragonflies (i.e., the zero-inflated component) but aren't predictors of abundance.

Similarly here, using flood height vs. time since last flood is roughly equivalent.

```{r}
# plot3.df <- broom::tidy(dfly.cand.models[[6]])
# plot3.df$model <- c("nbinom", "nbinom", "nbinom", "zi", "zi", "zi", "cond", "zi")
# plot3.df <- plot3.df[-c(1,4,7,8),]
# plot3.df$term <- c("Shading", "Days Since Flood", "Shading", "Days Since Flood")
# plot3.df$model <- as.factor(plot3.df$model)
# 
# plot4.df <- subset(plot3.df, model == "zi")
# coeff.plot4 <- dwplot(plot4.df, 
#        vline = geom_vline(xintercept = 0, colour = "grey80", linetype = 2, size = 1), 
#        dot_args = list(size = 4, colour = "#F8766D"), 
#        whisker_args = list(size = 0.75, colour = "#F8766D")) + 
#   theme_classic( base_size = 20, base_line_size = 1 ) + 
#   xlab("Coefficient Estimate") +
#   theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
#          legend.position = "none",
#          aspect.ratio = 1)
# 
# plot5.df <- subset(plot3.df, model == "nbinom")
# coeff.plot5 <- dwplot(plot5.df, 
#        vline = geom_vline(xintercept = 0, colour = "grey80", linetype = 2, size = 1), 
#        dot_args = list(size = 4, colour = "#619CFF"), 
#        whisker_args = list(size = 0.75, colour = "#619CFF")) + 
#   theme_classic( base_size = 20, base_line_size = 1 ) + 
#   xlab("Coefficient Estimate") +
#   theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
#          legend.position = "none",
#          aspect.ratio = 1)
# 
# # library(cowplot)
# # Fig3.plot <- plot_grid( coeff.plot1, coeff.plot2,
# #                         labels = c( "(a)", "(b)" ),
# #                         label_size = 16,
# #                         label_x = 0.2,
# #                         label_y = 0.99,
# #                         nrow = 2,
# #                         align = "hv" )
# 
# ggsave( "Fig4.png",
#         plot = coeff.plot4,
#         units = c("mm"),
#         dpi = 300 )
# 
# ggsave( "Fig5.png",
#         plot = coeff.plot5,
#         units = c("mm"),
#         dpi = 300 )
# 
# # dfly_effect.1 <- effect_plot(dfly.cand.models[[6]], pred = Pct_Shaded_Z, interval = TRUE, plot.points = TRUE, y.label = "Dragonfly Abundance", x.label = "Shading") 
# # dfly_effect.2 <- effect_plot(dfly.cand.models[[6]], pred = Days_Between_Z, interval = TRUE, plot.points = TRUE, y.label = "", x.label = "Days Since Last Flooded")
# # 
# # Fig4.plot <-  plot_grid( mosq_effect.1, mosq_effect.2, dfly_effect.1, dfly_effect.2,
# #                         labels = c( "(a)", "(b)", "(c)", "(d)" ),
# #                         label_size = 16,
# #                         label_x = 0.2,
# #                         label_y = 0.99,
# #                         nrow = 2,
# #                         align = "hv" )
# # 
# # ggsave( "Fig4.png",
# #         plot = Fig4.plot,
# #         units = c("mm"),
# #         dpi = 300 )
```