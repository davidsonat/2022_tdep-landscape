---
title: "Occupancy Models"
author: "Andy"
date: "2/15/2022"
output: html_document
---

Now that we have a working temperature model, let's play with occupancy models. First issue will be to determine detection probability for our two taxa of interest, dragonflies and mosquitoes. Note that these data are fairly preliminary, and I need to get the full set from Josh before proceeding with this analysis.


```{r}
library(unmarked)
occupancy.df <- read.csv("occ2021_reformat.csv")
occupancy.df <- occupancy.df[rowSums(is.na(occupancy.df[,3:10])) != 8, ]
occupancy.df$Pool_ID <- as.factor(occupancy.df$ï..Pool_ID)
occupancy.df$ï..Pool_ID <- NULL
occupancy.df$JulianDate <- as.factor(occupancy.df$JulianDate)

# Testing how to format data for unmarked:
# I can't get it to behave for multiple sampling dates. OccuMulti seems to be designed for a single sampling event, wherein each site is sampled up to J times.
abiotic.df <- read.csv("temp_predictions.csv")
occupancy.df <- merge(occupancy.df, abiotic.df)

# Grabbing pool level covariates
siteCovs <- as.data.frame(occupancy.df[c(1:2, 11:17)])

# Specify matrices of occ data, then make it into an unmarked dataframe
sp1 <- as.matrix(occupancy.df[c(3:6)])
sp2 <- as.matrix(occupancy.df[c(7:10)])

y <- list(sp1, sp2)

umf <- unmarkedFrameOccuMulti(y = y, siteCovs = siteCovs, obsCovs = NULL)
summary(umf) 


# I'm not sure if these covariates are in the right place. Should date and Pool ID be state-level covariates, and detection constant (~1)?
stateformulas <- c('~Temp_Zscore + Pool_ID', '~Temp_Zscore + Pool_ID', '~Temp_Zscore + Pool_ID')
detformulas <- c('~1', '~1')

mod1 <- occuMulti(stateformulas = stateformulas,
                  detformulas = detformulas,
             data = umf,
             se = TRUE)


summary(mod1)




# Need to get with Josh and ask about how to include Pool_ID or date and account for non-independent data points
# This is also the simplest possible model, and could perhaps be more informative with some other pool abiotic variables. Surface area, dist. to river channel, canopy?
stateformulas <- c('~Temp_Zscore', '~Temp_Zscore', '~Temp_Zscore')
detformulas <- c('~JulianDate', '~JulianDate')

mod2 <- occuMulti(stateformulas = stateformulas,
                  detformulas = detformulas,
             data = umf,
             se = TRUE,
             control = list(trace = TRUE))

summary(mod2)

predicted.fit <- predict(mod2, type='state')
predicted.vals <- as.data.frame(predicted.fit[1])
predicted.vals <- cbind(predicted.vals, siteCovs)
plot(x = predicted.vals$Temp_Zscore, y = predicted.vals$Predicted.psi.10.)
plot(x = predicted.vals$Temp_Zscore, y = predicted.vals$Predicted.psi.01.)

# What's mean occupancy of all three states?
mean(predicted.vals$Predicted.psi.10.) # 51.3% chance a pool had mosquitoes. Whoa! Predicted well by temperature (+ correlation).
mean(predicted.vals$Predicted.psi.01.) # Only a 17.0% chance of dragons. Not predicted by temperature.
mean(predicted.vals$Predicted.psi.11.) # Only 3.0% chance of both co-occurring. Also not predicted by temperature. This is a third of what would be expected based on random chance from the above probabilities (9%). 
# How would one directly analyze that? Some variety of goodness of fit test? See also Rota et al. 2016.
# Ask Josh also how he makes his figures.

# So if this model is correct, dragons go wherever in the landscape regardless of temperature, while mosquitoes seem to prefer warmer pools. The presence of dragons reduces the likelihood of mosquitoes being present.
```
