---
title: "Abundance Modeling"
author: "Andy"
date: "3/14/2022"
output: html_document
---

# Models of Mosquito Abundance

```{r, echo = FALSE, warnings = FALSE, message = FALSE, include = FALSE}
library(glmmTMB)
library(DHARMa)
library(dotwhisker)
library(broom)
library(broom.mixed)
library(jtools)
library(viridis)
library(AICcmodavg)
```

```{r, echo = FALSE, warnings = FALSE, message = FALSE}
abundance.df <- read.csv("abundance_data.csv")
abundance.df$Pool_ID <- as.factor(abundance.df$Pool_ID)
abundance.df$Date <- abundance.df$Date_Collected
abundance.df$Date <- as.factor(abundance.df$Date)
abundance.df$Date_Collected <- NULL
abundance.df$Date_Last_Flooded <- NULL

abiotic.df <- read.csv("temp_predictions.csv")
abiotic.df$Pool_ID <- as.factor(abiotic.df$Pool_ID)

abundance.df <- merge(abundance.df, abiotic.df)
abundance.df$lat <- NULL
abundance.df$long <- NULL
abundance.df$Temp_StdErr <- NULL
abundance2.df <- abundance.df[,2:11]
abundance2.df$Temp_Predicted_C <- NULL
abundance2.df$Date <- NULL

library(GGally)
ggpairs(abundance2.df)
```

## Model Family
### Standard Poisson GLMM

```{r, echo = FALSE}
abundance.df$Skimmer_Z <- (abundance.df$Skimmer_Dragonfly - mean(abundance.df$Skimmer_Dragonfly))/sd(abundance.df$Skimmer_Dragonfly)

mosq_poisson <- glmmTMB(Mosquito ~ Skimmer_Z * Temp_Zscore + (1 | Pool_ID), family = poisson(), data = abundance.df )
summary(mosq_poisson)
testDispersion(mosq_poisson) # It's overdispersed
testZeroInflation(mosq_poisson) # And zero-inflated
```


### Negative Binomial GLMM

```{r, echo = FALSE}
mosq_nbinom2 <- glmmTMB(Mosquito ~ Skimmer_Z * Temp_Zscore + (1 | Pool_ID), family = nbinom2(), data = abundance.df )
summary(mosq_nbinom2)
testDispersion(mosq_nbinom2)
testZeroInflation(mosq_nbinom2)

# nbinom1 had a similar AIC (slightly lower) but an insanely high dispersion parameter
```


### Zero-Inflated Poisson GLMM

```{r, echo = FALSE}
mosq_trunc_poisson <- glmmTMB(Mosquito ~ Skimmer_Z * Temp_Zscore + (1 | Pool_ID), ziformula = ~., family = truncated_poisson, data = abundance.df )
summary(mosq_trunc_poisson)
testDispersion(mosq_trunc_poisson)
testZeroInflation(mosq_trunc_poisson)
```


### Zero-Inflated Negative Binomial GLMM

```{r, echo = FALSE}
mosq_trunc_nbinom2 <- glmmTMB(Mosquito ~ Skimmer_Z * Temp_Zscore + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2, data = abundance.df )
summary(mosq_trunc_nbinom2)
testDispersion(mosq_trunc_nbinom2)
testZeroInflation(mosq_trunc_nbinom2) 

# Ditto here
```

The truncated negative binomial model seems to work the best (lowest AIC), and indicates a positive effect of temperature on mosquito abundance, a negative effect of dragonflies, and a positive interaction term. This suggests that mosquitoes are more abundant in warmer pools, less abundant where dragonflies are present, but temperature may mitigate this effect somewhat.


```{r, echo = FALSE, warnings = FALSE}
plot.df <- broom::tidy(mosq_trunc_nbinom2)
plot.df$model <- c("nbinom", "nbinom", "nbinom", "nbinom", "zi", "zi", "zi", "zi", "zi", "zi")
plot.df <- plot.df[-c(9,10),]
dwplot(plot.df, 
       vline = geom_vline(xintercept = 0, colour = "red", linetype = 2), 
       dot_args = list(size = 4), 
       line_args = list(size = 6)) + 
  theme_classic(base_size = 16) 
effect_plot(mosq_trunc_nbinom2, pred = Temp_Zscore, interval = TRUE, plot.points = TRUE) 
effect_plot(mosq_trunc_nbinom2, pred = Skimmer_Z, interval = TRUE, plot.points = TRUE)

abundance.df$drgn_presence <- ifelse(abundance.df$Skimmer_Dragonfly > 0, 'Present', 'Absent')
abundance.df$drgn_presence <- as.factor(abundance.df$drgn_presence)
abundance.df$rel_temp <- ifelse(abundance.df$Temp_Zscore > 0, 'Above Mean', 'Below Mean')
abundance.df$rel_temp <- as.factor(abundance.df$rel_temp)
abundance2.df <- abundance.df[which(abundance.df$Mosquito > 0),]
abundance3.df <- aggregate(abundance2.df$Mosquito, by = list(abundance2.df$rel_temp, abundance2.df$drgn_presence), FUN = 'mean')
colnames(abundance3.df) <- c("rel_temp", "drgn_presence", "Mosquito")
samplesize <- aggregate(abundance2.df$Mosquito, by = list(abundance2.df$rel_temp, abundance2.df$drgn_presence), FUN = 'length')
stdev <- aggregate(abundance2.df$Mosquito, by = list(abundance2.df$rel_temp, abundance2.df$drgn_presence), FUN = 'sd')
abundance3.df$std.err <- stdev[,3]/sqrt(samplesize[,3])

interaction.plot <- ggplot(data = abundance3.df, aes(y = Mosquito, x = drgn_presence, colour = rel_temp)) +
  geom_point(size = 5) +
  geom_errorbar(aes(ymin = Mosquito - std.err, ymax = Mosquito + std.err), width = 0.25, size = 0.75) +
  theme_classic( base_size = 24, base_line_size = 1 ) +   
  scale_y_continuous(expand = c(0,0)) +
  xlab("Dragonfly Nymphs") +
  ylab("Mosquito Abundance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        aspect.ratio = 1) +
  labs(colour = "Temperature")

ggsave( "interaction.png",
        plot = interaction.plot,
        units = c("mm"),
        dpi = 300)
```

Note: a temperature Z score of 1 means that the pool reaches a daily maximum temperature of around 34$^\circ$C, and the mean number of skimmers (i.e., Z = 0) was a little over 1.


## Models Including Flooding and Other Variables

```{r, echo = FALSE}
abundance.df$Days_Between_Z <- (abundance.df$Days_Between_Flood_Sampling - mean(abundance.df$Days_Between_Flood_Sampling))/sd(abundance.df$Days_Between_Flood_Sampling)

mosq_days <- glmmTMB(Mosquito ~ Skimmer_Z * Temp_Zscore + Days_Between_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2, data = abundance.df )
summary(mosq_days)
```

Including days since last flood doesn't improve the overall AIC, and doesn't shake out as a significant term.

```{r, echo = FALSE}
abundance.df$FloodedAt_Z <- (abundance.df$FloodedAt - mean(abundance.df$FloodedAt))/sd(abundance.df$FloodedAt)

mosq_floodheight <- glmmTMB(Mosquito ~ Skimmer_Z * Temp_Zscore + FloodedAt_Z + Days_Between_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2, data = abundance.df )
summary(mosq_floodheight)
```

Including flood height AND days since last flood improves AIC and both are significant terms in the zero inflation model. This suggests that lower flood height pools are more likely to have mosquitoes, and pools that have flooded more recently also have a higher likelihood.

This needs some playing with for model selection.

```{r, echo = FALSE}
mosq.cand.models <- list()

# Temperature alone
mosq.cand.models[[1]] <- glmmTMB(Mosquito ~ Temp_Zscore + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Dragons alone
mosq.cand.models[[2]] <- glmmTMB(Mosquito ~ Skimmer_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
mosq.cand.models[[3]] <- glmmTMB(Mosquito ~ Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Temperature and dragons
mosq.cand.models[[4]] <- glmmTMB(Mosquito ~ Temp_Zscore * Skimmer_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
mosq.cand.models[[5]] <- glmmTMB(Mosquito ~ Temp_Zscore + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Dragons and days since
mosq.cand.models[[6]] <- glmmTMB(Mosquito ~ Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# All three
mosq.cand.models[[7]] <- glmmTMB(Mosquito ~ Temp_Zscore * Skimmer_Z + Days_Between_Z + (1 | Date), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

mod.names <- paste("mod", 1:length(mosq.cand.models), sep = " " )
aictab(cand.set = mosq.cand.models, modnames = mod.names, sort = TRUE)

summary(mosq.cand.models[[4]])
```

Model 4, which includes skimmers and temperature only, wins. This one suggests that mosquitoes are less likely to be present when dragonflies are abundant, and when they are present, they're more abundant with fewer dragonflies, warmer temperatures, or in warm pools that have dragonflies.

Running this with flood height instead of time since last flood doesn't change the outcome much.


```{r, echo = FALSE, warnings = FALSE}
plot1.df <- broom::tidy(mosq.cand.models[[4]])
library(performance)
r2(mosq.cand.models[[4]]) # marginal r2 = 0.968, how is that even possible?
# Issue is with pool level random effect?
plot1.df$model <- c("nbinom", "nbinom", "nbinom", "nbinom", "zi", "zi", "zi", "zi", "cond", "zi")
plot1.df <- plot1.df[-c(1,5,9,10),]
plot1.df$term <- c("Max Temp. (°C)", "Dragonflies", "Temp:Dragonflies", "Max Temp. (°C)", "Dragonflies", "Temp:Dragonflies")
plot2.df <- plot1.df[1:3,]
plot3.df <- plot1.df[4:6,]


coeff1.df <- subset(plot1.df, model == "zi")
coeff.plot1 <- dwplot(coeff1.df, 
       vline = geom_vline(xintercept = 0, colour = "grey80", linetype = 2, size = 1), 
       dot_args = list(size = 4, colour = "#F8766D"), 
       whisker_args = list(size = 0.75, colour = "#F8766D")) + 
  theme_classic( base_size = 24, base_line_size = 1 ) + 
  xlab("Coefficient Estimate") +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "none",
         aspect.ratio = 1)

coeff2.df <- subset(plot1.df, model == "nbinom")
coeff.plot2 <- dwplot(coeff2.df, 
       vline = geom_vline(xintercept = 0, colour = "grey80", linetype = 2, size = 1), 
       dot_args = list(size = 4, colour = "#619CFF"), 
       whisker_args = list(size = 0.75, colour = "#619CFF")) + 
  theme_classic( base_size = 24, base_line_size = 1 ) + 
  xlab("Coefficient Estimate") +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "none",
         aspect.ratio = 1)


ggsave( "Fig2.png",
        plot = coeff.plot1,
        units = c("mm"),
        dpi = 300 )

ggsave( "Fig3.png",
        plot = coeff.plot2,
        units = c("mm"),
        dpi = 300 )


mosq_effect.1 <- effect_plot(mosq.cand.models[[4]], pred = Temp_Zscore, interval = TRUE, plot.points = TRUE, y.label = "Mosquito Abundance", x.label = "Max Temperature (°C)", point.size = 3) +  theme_classic( base_size = 24, base_line_size = 1 ) + 
  scale_y_continuous( expand = c(0, 0) ) +
  scale_x_continuous( expand = c(0, 0) ) +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "none",
         aspect.ratio = 1)
  
mosq_effect.2 <- effect_plot(mosq.cand.models[[4]], pred = Skimmer_Z, interval = TRUE, plot.points = TRUE, y.label = "Mosquito Abundance", x.label = "Dragonfly Abundance", point.size = 3) +  theme_classic( base_size = 24, base_line_size = 1 ) + 
  scale_y_continuous( expand = c(0, 0) ) +
  scale_x_continuous( expand = c(0, 0) ) +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "none",
         aspect.ratio = 1)

ggsave( "effectplot1.png",
        plot = mosq_effect.1,
        units = c("mm"),
        dpi = 300)

ggsave( "effectplot2.png",
        plot = mosq_effect.2,
        units = c("mm"),
        dpi = 300)
```


# Models of Dragonfly Abundance

## Model Family
### Poisson GLMM

```{r, echo = FALSE}
drgn_poisson <- glmmTMB(Skimmer_Dragonfly ~ Temp_Zscore + (1 | Pool_ID), family = poisson(), data = abundance.df)
summary(drgn_poisson)
testZeroInflation(drgn_poisson)
testDispersion(drgn_poisson) # Poisson has some issues with overdispersion
```


### Negative Binomial GLMM

```{r, echo = FALSE}
drgn_nbinom2 <- glmmTMB(Skimmer_Dragonfly ~ Temp_Zscore + (1 | Pool_ID), family = nbinom2(), data = abundance.df)
summary(drgn_nbinom2)
testZeroInflation(drgn_nbinom2)
testDispersion(drgn_nbinom2)

# Ditto about nbinom1() vs nbinom2()
```


### Zero-Inflated Poisson Model

```{r, echo = FALSE}
drgn_trunc_poisson <- glmmTMB(Skimmer_Dragonfly ~ Temp_Zscore + (1 | Pool_ID), ziformula = ~., family = truncated_poisson, data = abundance.df )
summary(drgn_trunc_poisson)
testDispersion(drgn_trunc_poisson)
testZeroInflation(drgn_trunc_poisson)
```


### Zero-Inflated Negative Binomial Model

```{r, echo = FALSE}
drgn_trunc_nbinom2 <- glmmTMB(Skimmer_Dragonfly ~ Temp_Zscore + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)
summary(drgn_trunc_nbinom2)
testZeroInflation(drgn_trunc_nbinom2)
testDispersion(drgn_trunc_nbinom2)

# There's still a bit of overdispersion here, but it beats nbinom1()
```

## Playing with Additional Variables

```{r, echo = FALSE}
drgn_trunc_nbinom2 <- glmmTMB(Skimmer_Dragonfly ~ Temp_Zscore + Pct_Shaded_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)
summary(drgn_trunc_nbinom2)
```

The zero-inflated negative binomial model has the lowest AIC. Dragonfly abundance isn't correlated with temperature, but their presence (from the zero-inflation model) seems to be more common in unshaded (but not necessarily warmer!) pools.

Now to play with additional variables of importance (e.g., days since last flood from Stunkle et al. 2021). It might also help to exclude temperature from the above model.

```{r, echo = FALSE}
dfly.cand.models <- list()

# Temperature alone
dfly.cand.models[[1]] <- glmmTMB(Skimmer_Dragonfly ~ Temp_Zscore + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Shading alone
dfly.cand.models[[2]] <- glmmTMB(Skimmer_Dragonfly ~ Pct_Shaded_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Days since last flooding alone
dfly.cand.models[[3]] <- glmmTMB(Skimmer_Dragonfly ~ Days_Between_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Temperature and shading
dfly.cand.models[[4]] <- glmmTMB(Skimmer_Dragonfly ~ Temp_Zscore + Pct_Shaded_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Temperature and days since
dfly.cand.models[[5]] <- glmmTMB(Skimmer_Dragonfly ~ Temp_Zscore + Days_Between_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# Shading and days since
dfly.cand.models[[6]] <- glmmTMB(Skimmer_Dragonfly ~ Pct_Shaded_Z + Days_Between_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

# All three
dfly.cand.models[[7]] <- glmmTMB(Skimmer_Dragonfly ~ Temp_Zscore + Pct_Shaded_Z + Days_Between_Z + (1 | Pool_ID), ziformula = ~., family = truncated_nbinom2(), data = abundance.df)

mod.names <- paste("mod", 1:length(dfly.cand.models), sep = " " )
aictab(cand.set = dfly.cand.models, modnames = mod.names, sort = TRUE)

summary(dfly.cand.models[[2]])
summary(dfly.cand.models[[6]])
```

Models 2 and 6 do best (and are roughly equivalent), which include just shading (mod2) or shading and days since last flood (mod6). Both suggest that less shady pools  should have dragonflies (i.e., the zero-inflated component) but aren't predictors of abundance.

Similarly here, using flood height vs. time since last flood is roughly equivalent.

```{r}
plot3.df <- broom::tidy(dfly.cand.models[[6]])
plot3.df$model <- c("nbinom", "nbinom", "nbinom", "zi", "zi", "zi", "cond", "zi")
plot3.df <- plot3.df[-c(1,4,7,8),]
plot3.df$term <- c("Shading", "Days Since Flood", "Shading", "Days Since Flood")
plot3.df$model <- as.factor(plot3.df$model)

plot4.df <- subset(plot3.df, model == "zi")
coeff.plot4 <- dwplot(plot4.df, 
       vline = geom_vline(xintercept = 0, colour = "grey80", linetype = 2, size = 1), 
       dot_args = list(size = 4, colour = "#F8766D"), 
       whisker_args = list(size = 0.75, colour = "#F8766D")) + 
  theme_classic( base_size = 20, base_line_size = 1 ) + 
  xlab("Coefficient Estimate") +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "none",
         aspect.ratio = 1)

plot5.df <- subset(plot3.df, model == "nbinom")
coeff.plot5 <- dwplot(plot5.df, 
       vline = geom_vline(xintercept = 0, colour = "grey80", linetype = 2, size = 1), 
       dot_args = list(size = 4, colour = "#619CFF"), 
       whisker_args = list(size = 0.75, colour = "#619CFF")) + 
  theme_classic( base_size = 20, base_line_size = 1 ) + 
  xlab("Coefficient Estimate") +
  theme( panel.border = element_rect( color = "black", fill = NA, size = 0.75 ),
         legend.position = "none",
         aspect.ratio = 1)

# library(cowplot)
# Fig3.plot <- plot_grid( coeff.plot1, coeff.plot2,
#                         labels = c( "(a)", "(b)" ),
#                         label_size = 16,
#                         label_x = 0.2,
#                         label_y = 0.99,
#                         nrow = 2,
#                         align = "hv" )

ggsave( "Fig4.png",
        plot = coeff.plot4,
        units = c("mm"),
        dpi = 300 )

ggsave( "Fig5.png",
        plot = coeff.plot5,
        units = c("mm"),
        dpi = 300 )

# dfly_effect.1 <- effect_plot(dfly.cand.models[[6]], pred = Pct_Shaded_Z, interval = TRUE, plot.points = TRUE, y.label = "Dragonfly Abundance", x.label = "Shading") 
# dfly_effect.2 <- effect_plot(dfly.cand.models[[6]], pred = Days_Between_Z, interval = TRUE, plot.points = TRUE, y.label = "", x.label = "Days Since Last Flooded")
# 
# Fig4.plot <-  plot_grid( mosq_effect.1, mosq_effect.2, dfly_effect.1, dfly_effect.2,
#                         labels = c( "(a)", "(b)", "(c)", "(d)" ),
#                         label_size = 16,
#                         label_x = 0.2,
#                         label_y = 0.99,
#                         nrow = 2,
#                         align = "hv" )
# 
# ggsave( "Fig4.png",
#         plot = Fig4.plot,
#         units = c("mm"),
#         dpi = 300 )
```